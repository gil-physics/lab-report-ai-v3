import os
import google.generativeai as genai
import re


async def generate_ai_content(exp_name, analysis, template_id, template_content=None, raw_data_summary=None, csv_data=None):
    # Load API key at runtime, not at import time
    GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
    if not GOOGLE_API_KEY:
        return "AI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë‚´ìš©ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    # --- [AI API LOGIC - NOW ACTIVE] ---
    genai.configure(api_key=GOOGLE_API_KEY)
    
    try:
        model = genai.GenerativeModel('gemini-pro-latest')
        
        # Build prompt using template if available
        template_context = ""
        if template_content:
            template_context = f"\n[ì°¸ê³ í•  ë³´ê³ ì„œ í…œí”Œë¦¿ êµ¬ì¡°]\n{template_content}\n"

        # ğŸ“Š CSV ì›ë³¸ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€ (í™˜ê° ë°©ì§€)
        csv_context = ""
        if csv_data:
            # ì²˜ìŒ 500ìë§Œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì œê³µ (ë„ˆë¬´ ê¸¸ë©´ í† í° ë‚­ë¹„)
            csv_preview = csv_data[:500] if len(csv_data) > 500 else csv_data
            csv_context = f"""
[ì›ë³¸ CSV ë°ì´í„° (ì°¸ê³ ìš©)]
{csv_preview}

âš ï¸ ì£¼ì˜: ìœ„ ë°ì´í„°ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ëª¨ë“  ìˆ˜ì¹˜ëŠ” ì•„ë˜ 'ë¶„ì„ ê²°ê³¼ ì •ë³´'ì˜ Python ê³„ì‚° ê°’ì„ ì •í™•íˆ ì‚¬ìš©í•˜ì„¸ìš”.
"""

        # ğŸ“Š ë°ì´í„° í†µê³„ ìš”ì•½ ì •ë³´ ìƒì„±
        data_desc = ""
        example_citation = ""
        if raw_data_summary:
            data_desc = f"""
        [ì‹¤í—˜ ë°ì´í„° í†µê³„ ìš”ì•½]
        - ë°ì´í„° ê°œìˆ˜: {raw_data_summary.get('count', 0)} ê°œ
        - Xê°’ ë²”ìœ„: {raw_data_summary.get('x_min', 0):.4f} ~ {raw_data_summary.get('x_max', 0):.4f}
        - Yê°’ ë²”ìœ„: {raw_data_summary.get('y_min', 0):.4f} ~ {raw_data_summary.get('y_max', 0):.4f}
        - Yê°’ í‰ê· : {raw_data_summary.get('y_mean', 0):.4f} (í‘œì¤€í¸ì°¨: {raw_data_summary.get('y_std', 0):.4f})
        """
            example_citation = f"ì˜ˆ: \"ì¸¡ì •ëœ Yê°’ì€ í‰ê·  {raw_data_summary.get('y_mean', 0):.2f}ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ {raw_data_summary.get('y_min', 0):.2f}ì—ì„œ {raw_data_summary.get('y_max', 0):.2f} ì‚¬ì´ì˜ ë²”ìœ„ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.\""

        # ğŸ§  AI í”„ë¡¬í”„íŠ¸ ê³ ë„í™” (ë°ì´í„° ì£¼ì…): í™˜ê° ë°©ì§€ë¥¼ ìœ„í•´ ëª…í™•í•œ ìˆ˜ì¹˜ ì œê³µ
        from api.utils.significant_figures import format_with_uncertainty
        
        params_info = []
        if 'params' in analysis:
            p_vals = analysis.get('params', [])
            p_errs = analysis.get('standard_errors', [0.0] * len(p_vals))
            p_names = ['a', 'b', 'c', 'd', 'e']
            for i, (v, e) in enumerate(zip(p_vals, p_errs)):
                n = p_names[i] if i < len(p_names) else f"p{i}"
                # Use scientific formatting for uncertainties
                params_info.append(f"{n} = {format_with_uncertainty(v, e, sig_figs=2)}")
        
        params_text = f"ì£¼ìš” íŒŒë¼ë¯¸í„° ìƒì„¸ ê°’ (ì¸¡ì • ì˜¤ì°¨ í¬í•¨): {', '.join(params_info)}" if params_info else ""
        
        min_sig_figs = analysis.get('min_sig_figs', 3)
        x_unit = analysis.get('x_unit', '')
        y_unit = analysis.get('y_unit', '')

        prompt = f"""
# Role (ì—­í• )
ë‹¹ì‹ ì€ ëŒ€í•™ ë¬¼ë¦¬í•™ ì‹¤í—˜ ê³¼ëª©ì˜ ì „ë¬¸ ì¡°êµ(TA)ì´ì í•™ìˆ  ì‘ë¬¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì œê³µëœ ì‹¤í—˜ ë°ì´í„°ì™€ ë°°ê²½ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë…¼ë¦¬ì ì´ê³ , ê³¼í•™ì ìœ¼ë¡œ ì—„ë°€í•˜ë©°, ê°€ë…ì„±ì´ ë›°ì–´ë‚œ 'ë¬¼ë¦¬í•™ ì‹¤í—˜ ë³´ê³ ì„œ ì´ˆì•ˆ'ì„ ì‘ì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

# Task (ì„ë¬´)
ì•„ë˜ [Input Data]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬¼ë¦¬ ì‹¤í—˜ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ë³´ê³ ì„œëŠ” ì¼ë°˜ì ì¸ ë¬¼ë¦¬ ì‹¤í—˜ ë³´ê³ ì„œì˜ í‘œì¤€ êµ¬ì¡°(ì„œë¡ , ì´ë¡ , ì‹¤í—˜ ë°©ë²•, ê²°ê³¼ ë° ë¶„ì„, í† ì˜, ê²°ë¡ )ë¥¼ ë”°ë¼ì•¼ í•˜ë©°, íŠ¹íˆ ë°ì´í„° ë¶„ì„ê³¼ ì˜¤ì°¨ ë…¼ì˜ì— ìˆì–´ ê¹Šì´ ìˆëŠ” í†µì°°ë ¥ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

# Input Data (ì…ë ¥ ë°ì´í„°)
1. ì‹¤í—˜ ì œëª©: {exp_name}
2. ì ìš©ëœ ë¬¼ë¦¬ ì´ë¡  ë° í‚¤ì›Œë“œ: {template_id if template_id != 'none' else 'ê¸°ë³¸ ë¬¼ë¦¬í•™ ë²•ì¹™'}
3. [ì¤‘ìš”] ë¶„ì„ ê²°ê³¼ ë° ê³„ì‚°ê°’ (Source of Truth):
   - íšŒê·€ ëª¨ë¸: {analysis.get('name', analysis.get('model', 'N/A'))}
   - ë„ì¶œëœ ìˆ˜ì‹: {analysis.get('equation', 'N/A')}
   - ê²°ì •ê³„ìˆ˜ (RÂ²): {analysis.get('r_squared', 0):.4f}
   - ìµœì†Œ ìœ íš¨ìˆ«ì ê¸°ì¤€: {min_sig_figs} ìë¦¬
   - X ë‹¨ìœ„: {x_unit if x_unit else 'ì—†ìŒ'}
   - Y ë‹¨ìœ„: {y_unit if y_unit else 'ì—†ìŒ'}
   - {params_text}
4. [ì°¸ê³ ] ì‹¤í—˜ ë°ì´í„° í†µê³„ ìš”ì•½:
   {data_desc if data_desc else "ìš”ì•½ ì •ë³´ ì—†ìŒ"}
5. [ì°¸ê³ ] ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:
   {csv_context if csv_context else "ì›ë³¸ ë°ì´í„° ì—†ìŒ"}
6. [ì°¸ê³ ] ë³´ê³ ì„œ í…œí”Œë¦¿ êµ¬ì¡°:
   {template_context if template_context else "ê¸°ë³¸ êµ¬ì¡° ì‚¬ìš©"}

# Guidelines & Constraints (ì§€ì¹¨ ë° ì œì•½ì‚¬í•­)

## 1. í™˜ê° ë°©ì§€ ë° ë…¼ë¦¬ (Anti-Hallucination & Logic)
- **Zero-Inference:** ì œê³µëœ ë°ì´í„°(Input Data 3, 4ë²ˆ)ì— ì—†ëŠ” ìˆ˜ì¹˜ë¥¼ ì ˆëŒ€ ì§€ì–´ë‚´ê±°ë‚˜ ì¶”ì¸¡í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ "ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ í™•ì¸ ë¶ˆê°€"ë¼ê³  ëª…ì‹œí•˜ì‹­ì‹œì˜¤. **ë‹¹ì‹ ì´ ì§ì ‘ ê³„ì‚°í•˜ì§€ ë§ê³ , ì œê³µëœ ê³„ì‚°ê°’(Source of Truth)ë§Œ ì •í™•íˆ ì¸ìš©í•˜ì‹­ì‹œì˜¤.**
- **Scientific Grounding:** ë¬¼ë¦¬ ì´ë¡ ì„ ì„¤ëª…í•  ë•ŒëŠ” í•™ìˆ ì ìœ¼ë¡œ ê²€ì¦ëœ ë‚´ìš©ë§Œ í¬í•¨í•˜ì‹­ì‹œì˜¤.
- **Chain of Thought (CoT):** ê²°ê³¼ ë¶„ì„ ë° í† ì˜ ì„¹ì…˜ ì‘ì„± ì‹œ, "ë°ì´í„°ê°€ A ê²½í–¥ì„ ë³´ì´ë¯€ë¡œ ì´ë¡ ê°’ Bì™€ ë¹„êµí–ˆì„ ë•Œ Cë¼ëŠ” ê²°ë¡ ì´ ë„ì¶œëœë‹¤"ëŠ” ì‹ì˜ ë…¼ë¦¬ì  ì¶”ë¡  ê³¼ì •ì„ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
- **Scientific Precision:** ì œê³µëœ ìœ íš¨ìˆ«ì ê¸°ì¤€({min_sig_figs} ìë¦¬)ì„ ì¸ì§€í•˜ê³ , ì˜¤ì°¨ ë²”ìœ„(Â±)ê°€ í¬í•¨ëœ íŒŒë¼ë¯¸í„° ê°’ì„ ë…¼ì˜í•  ë•Œ ê·¸ ì˜ë¯¸(ì •ë°€ë„, ì •í™•ë„)ë¥¼ í•´ì„í•˜ì‹­ì‹œì˜¤. ë‹¨ìœ„({x_unit}, {y_unit})ë¥¼ ëˆ„ë½í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

## 2. ì„œì‹ ë° í‘œê¸° ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
ë‹¤ìŒì˜ í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì²˜ë¦¬ ê·œì¹™ ë° ë Œë”ë§ ê°€ì´ë“œë¼ì¸ì„ **ë°˜ë“œì‹œ** ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.

- **ìˆ˜ì‹ ê¸°í˜¸($) ì¤‘ë³µ ì ˆëŒ€ ê¸ˆì§€ (Parser Error ë°©ì§€):** ëª¨ë“  ìˆ˜ì‹ì€ ë‹¨ì¼ ìŒì˜ ê¸°í˜¸ë¡œë§Œ ê°ì‹¸ì•¼ í•©ë‹ˆë‹¤. ì´ë¯¸ `$ ... $` í˜•íƒœì¸ í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ `$` ë¡œ ê°ì‹¸ëŠ” í–‰ìœ„(ì˜ˆ: `$ $...$ $`)ë¥¼ ì ˆëŒ€ ê¸ˆì§€ í•©ë‹ˆë‹¤. íŠ¹íˆ **Input Data 3ë²ˆ** ì˜ ìˆ˜ì‹ì€ ì´ë¯¸ ì™„ì„±ëœ LaTeX í˜•íƒœì´ë¯€ë¡œ, ì–´ë– í•œ ê¸°í˜¸ë„ ì¶”ê°€í•˜ì§€ ë§ê³  **ìˆëŠ” ê·¸ëŒ€ë¡œ(Raw Text) ì¸ìš©**í•˜ì‹­ì‹œì˜¤.
- **í† í° ê²°í•© ë° ê³µë°± ê·œì¹™:**
  - **ë‚´ë¶€ ê³µë°± ì œê±°:** ìˆ˜ì‹ ê¸°í˜¸ ë°”ë¡œ ì•ˆìª½ì—ëŠ” ê³µë°±ì´ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: `$R^2$` (O), `$ R^2 $` (X))
  - **ì™¸ë¶€ ê³µë°± í•„ìˆ˜:** ìˆ˜ì‹ ê¸°í˜¸(`$`)ì™€ í•œê¸€ ì¡°ì‚¬ ë˜ëŠ” ë‹¨ì–´ ì‚¬ì´ì—ëŠ” **ë°˜ë“œì‹œ í•œ ì¹¸ì˜ ê³µë°±** ì„ í¬í•¨í•˜ì‹­ì‹œì˜¤. ì´ëŠ” í…ìŠ¤íŠ¸ ê°€ë…ì„±ê³¼ ì„œì‹ ë Œë”ë§ ìµœì í™”ë¥¼ ìœ„í•¨ì…ë‹ˆë‹¤. (ì˜ˆ: "ê²°ê³¼ëŠ” `$x$` ì…ë‹ˆë‹¤." (O), "ê²°ê³¼ëŠ”`$x$`ì…ë‹ˆë‹¤." (X))
- **ê°•ì¡° ì„œì‹(Bold) ë„ì–´ì“°ê¸°:** `**ë‹¨ì–´**`ì˜ ì•ì´ë‚˜ ë’¤ì— í•œê¸€ ì¡°ì‚¬ë‚˜ ë‹¨ì–´ê°€ ì´ì–´ì§ˆ ê²½ìš°, ë°˜ë“œì‹œ í•œ ì¹¸ ë„ìš°ì‹­ì‹œì˜¤. (ì˜ˆ: "**ë‰´í„´** ì˜ ë²•ì¹™")
- **LaTeX ë¬¸ë²• ë° ìŠ¤íƒ€ì¼:**
  - ëª¨ë“  ìˆ˜í•™ì  ë³€ìˆ˜ëŠ” **ì´íƒ¤ë¦­ì²´**ë¡œ í‘œê¸°í•˜ë©°, í‘œì¤€ LaTeX ë¬¸ë²•ì„ ë”°ë¥´ì‹­ì‹œì˜¤.
  - **Display Mode:** ë…ë¦½ëœ ì¤„ì— ë°°ì¹˜í•  ë•ŒëŠ” `$$...$$` ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
  - **Inline Mode:** ë¬¸ì¥ ì¤‘ê°„ì— ì‚½ì…í•  ë•ŒëŠ” `$ ... $` ë¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

## 3. ë³´ê³ ì„œ êµ¬ì¡° (Report Structure)
- **í…œí”Œë¦¿ ìš°ì„  ìˆœìœ„:** ì œê³µëœ [ë³´ê³ ì„œ í…œí”Œë¦¿ êµ¬ì¡°]ê°€ ìˆë‹¤ë©´, í•´ë‹¹ í…œí”Œë¦¿ì˜ ëª©ì°¨ì™€ í˜•ì‹ì„ **ì ˆëŒ€ì ìœ¼ë¡œ** ë”°ë¥´ì‹­ì‹œì˜¤. í…œí”Œë¦¿ì— `[ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”]`ì™€ ê°™ì€ í”Œë ˆì´ìŠ¤í™€ë”ê°€ ìˆë‹¤ë©´ ì´ë¥¼ ë¶„ì„ ê²°ê³¼ë¡œ ì±„ì›Œ ë„£ìœ¼ì‹­ì‹œì˜¤.
- **ê¸°ë³¸ êµ¬ì¡° (í…œí”Œë¦¿ ì—†ì„ ì‹œ):**
    1. **ì„œë¡  (Introduction):** ì‹¤í—˜ ëª©ì ê³¼ ë°°ê²½ ì´ë¡  ì†Œê°œ.
    2. **ì‹¤í—˜ ë°©ë²• (Methods):** ì ˆì°¨ë¥¼ ê³¼ê±°í˜•ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ê¸°ìˆ .
    3. **ê²°ê³¼ ë° ë¶„ì„ (Results & Analysis):** ì œê³µëœ ë¶„ì„ ê²°ê³¼ë¥¼ ìš”ì•½í•˜ê³  ì£¼ìš” ê²½í–¥ì„± ë° ì˜¤ì°¨ìœ¨ì„ ì„œìˆ .
4. **í† ì˜ (Discussion):** ì˜¤ì°¨ì˜ ì›ì¸ì„ 'ê³„í†µ ì˜¤ì°¨'ì™€ 'ìš°ì—° ì˜¤ì°¨'ë¡œ êµ¬ë¶„í•˜ì—¬ ë¶„ì„. ì¥ë¹„ì˜ í•œê³„, í™˜ê²½ì  ìš”ì¸ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ .
    5. **ê²°ë¡  (Conclusion):** ëª©ì  ë‹¬ì„± ì—¬ë¶€ ìš”ì•½.

# Output Format (ì¶œë ¥ í˜•ì‹)
- ì œê³µëœ í…œí”Œë¦¿ì˜ ë‚´ìš©ì„ **ê·¸ëŒ€ë¡œ ìœ ì§€**í•˜ë©´ì„œ, í”Œë ˆì´ìŠ¤í™€ë” ë¶€ë¶„ë§Œ ë‹¹ì‹ ì˜ ì „ë¬¸ì ì¸ ë¶„ì„ìœ¼ë¡œ êµì²´í•˜ì—¬ ì™„ì„±ëœ ë³´ê³ ì„œë¥¼ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
- **HTML ì´ë¯¸ì§€ íƒœê·¸ ë³´ì¡´ (IMPORTANT):** í…œí”Œë¦¿ ë‚´ì— í¬í•¨ëœ `<img src="..." width="..." align="..." />` ì™€ ê°™ì€ HTML íƒœê·¸ëŠ” ê·¸ë˜í”„ë¥¼ ì¶œë ¥í•˜ê¸° ìœ„í•œ ì¤‘ìš”í•œ ì½”ë“œì…ë‹ˆë‹¤. ì´ë¥¼ **ì ˆëŒ€ ì‚­ì œí•˜ê±°ë‚˜ ë³€ê²½í•˜ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ì¶œë ¥**ì— í¬í•¨í•˜ì‹­ì‹œì˜¤.
- **ë°ì´í„° ì¤‘ì‹¬ ë¶„ì„:** ê·¸ë˜í”„ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì„¤ëª…í•˜ë ¤ í•˜ì§€ ë§ê³ (ì˜ˆ: "ë¹¨ê°„ ì„ ì´ ë³´ì…ë‹ˆë‹¤"), ì œê³µëœ **ìˆ˜ì¹˜ ë°ì´í„°(Input Data 3ë²ˆ)**ì¸ ê²°ì •ê³„ìˆ˜, ê¸°ìš¸ê¸°, ì˜¤ì°¨ê°’ ë“±ì„ ë°”íƒ•ìœ¼ë¡œ í˜„ìƒì„ ë…¼ë¦¬ì ìœ¼ë¡œ í•´ì„í•˜ì‹­ì‹œì˜¤.
- ì „ì²´ ì¶œë ¥ì€ Markdown í˜•ì‹ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
- ì£¼ìš” ì„¹ì…˜ì€ `##` ë˜ëŠ” í…œí”Œë¦¿ì— ì •ì˜ëœ í—¤ë” ìˆ˜ì¤€ìœ¼ë¡œ êµ¬ë¶„í•˜ì‹­ì‹œì˜¤.

ì§€ê¸ˆë¶€í„° ìœ„ ì§€ì¹¨ì„ ì™„ë²½íˆ ìˆ™ì§€í•˜ê³  ë³´ê³ ì„œ ì´ˆì•ˆ ì‘ì„±ì„ ì‹œì‘í•˜ì‹­ì‹œì˜¤.
"""
        
        response = await model.generate_content_async(prompt)
        
        # Check if response was blocked or has no text
        if not response.text:
            error_details = []
            if hasattr(response, 'prompt_feedback'):
                error_details.append(f"Prompt feedback: {response.prompt_feedback}")
            if hasattr(response, 'candidates') and response.candidates:
                for i, candidate in enumerate(response.candidates):
                    error_details.append(f"Candidate {i} finish_reason: {candidate.finish_reason}")
            
            error_msg = "AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. " + " | ".join(error_details) if error_details else "AI ì‘ë‹µì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            return error_msg
        
        return response.text
    except Exception as e:
        error_str = str(e)
        if "429" in error_str or "quota" in error_str.lower():
            return "AI ìƒì„± í• ë‹¹ëŸ‰(Quota)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë¬´ë£Œ í‹°ì–´ì˜ ì¼ì¼ ì œí•œì— ë„ë‹¬í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ ì£¼ì„¸ìš”."
        return f"AI ë‚´ìš© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {error_str}"

